
@{
    ViewBag.Title = "ChiTietChuyenLop";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int id_trungtam = ViewBag.TrungTam;
}
<style>
    .btn {
        min-width: 80px;
    }
</style>
<script src="~/Content/js/bootbox.min.js"></script>
<div class="box box-danger">
    <div class="box-header with-border">
        <h3 class="box-title">Danh sách chờ duyệt</h3>
    </div>
    <form class="form-horizontal">
        <div class="row">
            <div class="col-md-12">
                <div id="gridDanhSachChoDuyet"></div>
            </div>
        </div>
    </form>
</div>
<div class="box box-danger">
    <div class="box-header with-border">
        <h3 class="box-title">Đăng ký chuyển lớp</h3>
    </div>
    <form class="form-horizontal">
        <div class="margin text-right">
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger" onclick="ThemMoi()">Thêm mới</button></div>
            <div class="btn-group"><button type="button" id="btnLuu" class="btn btn-block btn-danger" onclick="Luu()">Lưu</button></div>
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger" onclick="DuyetTiepNhanChuyenLop()">Duyệt</button></div>
        </div>
        <div class="box-body">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-left: 0px!important">Tìm học viên</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="text" class="form-control" disabled id="TIMKIEMHOCVIEN" data-foo>
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-block btn-danger" onclick="TimKiemHocSinh()">Tìm kiếm</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Số ĐT</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="DienThoai" placeholder="" data-foo>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-sm-2 control-label"></label>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Email</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="Email" placeholder="" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Địa chỉ</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="DiaChi" placeholder="" data-foo>
                    </div>
                </div>
            </div>
        </div>
        <div class="box-body" style="padding-top:0px">
            <div class="col-md-6">
                <div class="form-group">
                    <h5><label class="col-sm-12 control-label text-bold" style="text-align:left">THÔNG TIN HỌC LỚP ĐANG HỌC</label></h5>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Tên lớp</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="TenLop" placeholder="" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Trung tâm</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="TrungTam" placeholder="" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Chương trình</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="ChuongTrinh" placeholder="" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Ngày chuyển</label>
                    <div class="col-sm-4">
                        <div id="NgayChuyen" style="width:100%"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Buổi 1</label>
                    <div class="col-sm-4">
                        <input type="text" id="Buoi1" readonly class="form-control" data-foo>
                    </div>
                    <label class="col-sm-2 control-label" style="padding-right: 0px!important">Buổi 2</label>
                    <div class="col-sm-4">
                        <input type="text" id="Buoi2" readonly class="form-control" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Số buổi</label>
                    <div class="col-sm-4">
                        <input type="text" id="SoBuoi" readonly class="form-control" data-foo>
                    </div>
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Số buổi còn lại</label>
                    <div class="col-sm-4">
                        <input type="text" id="SoBuoiConLai" readonly class="form-control" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Đơn giá</label>
                    <div class="col-sm-4">
                        <input type="text" id="DonGia" readonly class="form-control" data-foo>
                    </div>
                    <label class="col-sm-2 control-label" style="padding-right:7px 0px!important">Thành tiền còn lại</label>
                    <div class="col-sm-4">
                        <input type="text" id="ThanhTienConLai" readonly class="form-control" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Ngày bắt đầu</label>
                    <div class="col-sm-4">
                        <input type="text" id="NgayBatDau" readonly class="form-control" data-foo>
                    </div>
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Ngày học cuối</label>
                    <div class="col-sm-4">
                        <input type="text" id="NgayKetThuc" readonly class="form-control" data-foo>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <h5><label class="col-sm-12 control-label text-bold" style="text-align:left">THÔNG TIN LỚP CHUYỂN ĐẾN</label></h5>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Trung tâm</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="text" class="form-control" id="TIMKIEMTRUNGTAM" disabled data-foo>
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-block btn-danger" onclick="TimKiemTrungTam()">Tìm kiếm</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Lớp học</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="text" class="form-control" id="TIMKIEMLOPHOC" disabled data-foo>
                            <span class="input-group-btn">
                                <button id="btnTimLopHoc" type="button" class="btn btn-block btn-danger" onclick="TimKiemLop()">Tìm kiếm</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Chương trình</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="ChuongTrinhLopChuyenDen" placeholder="" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Buổi 1</label>
                    <div class="col-sm-4">
                        <input type="text" id="Buoi1LopChuyenDen" readonly class="form-control" data-foo>
                    </div>
                    <label class="col-sm-2 control-label">Buổi 2</label>
                    <div class="col-sm-4">
                        <input type="text" id="Buoi2LopChuyenDen" readonly class="form-control" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Số buổi nhận</label>
                    <div class="col-sm-4">
                        <input type="text" id="SoBuoiNhanLopChuyenDen" readonly class="form-control" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Đơn giá</label>
                    <div class="col-sm-4">
                        <input type="text" id="DonGiaLopChuyenDen" readonly class="form-control" data-foo>
                    </div>
                    <label class="col-sm-2 control-label" style="padding-left: 0px!important">Thành tiền</label>
                    <div class="col-sm-4">
                        <input type="text" id="ThanhTienLopChuyenDen" readonly class="form-control" data-foo>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Ngày bắt đầu</label>
                    <div class="col-sm-4">
                        <div id="NgayBatDauLopChuyenDen" style="width:100%"></div>
                    </div>
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Ngày học cuối</label>
                    <div class="col-sm-4">
                        <input id="NgayKetThucLopChuyenDen" readonly class="form-control" data-foo />
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<div class="box box-danger">
    <div class="box-header with-border">
        <h3 class="box-title">Lịch sử chuyển lớp</h3>
    </div>
    <form class="form-horizontal">
        <div class="row">
            <div class="col-md-12">
                <div id="gridLichSuChuyenLop"></div>
            </div>
        </div>
        <div class="box-footer">
        </div>
    </form>
</div>
<div class="modal fade" id="TimHocVien" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-red">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Danh sách học viên đã xếp lớp</h4>
            </div>
            <div class="modal-body">
                <div id="gridDanhSachHocSinhDaXepLop">
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="TimLopHoc" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-red">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Danh sách lớp học</h4>
            </div>
            <div class="modal-body">
                <div id="gridDanhSachHocLopHoc">
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="TimTrungTam" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-red">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Danh sách trung tâm</h4>
            </div>
            <div class="modal-body">
                <div id="gridDanhSachTrungTam">
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="DuyetTiepNhan" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-red">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Duyệt thực hiện</h4>
            </div>
            <div class="modal-body">
                <div class="box-body">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">Tên người dùng</label>
                            <div class="col-sm-8">
                                <input type="text" id="TenNguoiDung" readonly class="form-control">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:40px;">
                            <label class="col-sm-4 control-label" style="padding-left:0px">Nội dung/Ghi chú</label>
                            <div class="col-sm-8">
                                <textarea class="form-control" rows="2" id="GhiChuDuyet" placeholder="Nội dung ..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">Ý kiến duyệt<span style="color:red">*</span></label>
                            <div class="col-sm-8">
                                <div id="YKienDuyet" style="width:100%"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:40px;">
                            <div class="col-sm-8">
                                <button id="LuuDuyet" style="width:90px;height:53px;border-radius:5px;border-color:red" onclick="LuuDuyetTiepNhanChuyenLop()" class="btn-danger">Duyệt</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="gridDanhSachLichSuDuyet">
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var sobuoiconlai = 0,
        chuyentrungtam = true,
        a_hosokhachhang,
        lopcu_dubao,
        lopcu_trungtam,
        lopcu_kehoach,
        lopcu_sanpham,
        lopcu_buoi1 = 0,
        lopcu_buoi2 = 0,
        lopcu_khuvuc = 0,
        lopcu_chietkhau = 0,

        lopmoi_sanpham,
        lopmoi_trungtam,
        lopmoi_buoi1 = 0,
        lopmoi_buoi2 = 0,
        lopmoi_kehoach,
        lopmoi_khuvuc = 0,
        a_thdubao = 0,
        lopmoi_chietkhau = 0,
        xemlichsu = false;

    $(document).ready(function () {
        LoadThongTinTrungTam(@id_trungtam);
        LoadNgayBatDauLopChuyenDen();
        LoadNgayChuyen();
        LoadDanhMucDuyet();
        LoadDanhSachChoDuyet();
    })
    function LoadNgayChuyen() {
        $("#NgayChuyen").dxDateBox({
            formatString: 'dd/MM/yyyy',
            hint: 'dd/MM/yyyy',
            onChange: function (data) {
                var dateBox = $("#NgayChuyen").dxDateBox("instance");
                var dateBoxValue = dateBox.option('text');
                $("#NgayChuyen").dxDateBox('instance').option('value', ConvertDate(dateBoxValue));
            },
            onValueChanged: function (data) {
                if (!xemlichsu) {
                    $.ajax({
                        url: '@Url.Action("TinhBuoiConLai", "DangKyChuyenLop")',
                        data: {
                            NgayBatDau: $('#NgayBatDau').val(),
                            NgayChuyen: Globalize.format(data.value, 'yyyy-MM-dd'),
                            NgayKetThuc: $('#NgayKetThuc').val(),
                            KhuVuc: lopcu_khuvuc,
                            HocVien: a_hosokhachhang,
                            LopHoc: lopcu_kehoach,
                            Buoi1: lopcu_buoi1,
                            Buoi2: lopcu_buoi2,
                            A_DuBao: lopcu_dubao
                        },
                        type: 'GET',
                        contentType: 'application/json',
                        success: function (rs) {
                            $("#SoBuoiConLai").val(rs);
                            var dg = Number($('#DonGia').val().replace(/,/g, ''));
                            var tt = rs * dg;
                            $("#ThanhTienConLai").val(tt.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));

                            $('#SoBuoiNhanLopChuyenDen').val(rs);
                            $('#DonGiaLopChuyenDen').val(dg.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                            $('#ThanhTienLopChuyenDen').val(tt.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"))
                        }
                    })
                }
            },
        }).dxDateBox("instance");
    }
    function LoadNgayBatDauLopChuyenDen() {
        $("#NgayBatDauLopChuyenDen").dxDateBox({
            formatString: 'dd/MM/yyyy',
            hint: 'dd/MM/yyyy',
            onChange: function (data) {
                var dateBox = $("#NgayBatDauLopChuyenDen").dxDateBox("instance");
                var dateBoxValue = dateBox.option('text');
                $("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('value', ConvertDate(dateBoxValue));
            },
            onValueChanged: function (data) {
                if (!xemlichsu) {
                    $.ajax({
                        url: '@Url.Action("LayNGayKetThucHoanChinh", "DangKyChuyenLop")',
                        data: {
                            ngaybd: Globalize.format(data.value, 'yyyy-MM-dd'),
                            SoBuoi: Number($('#SoBuoiNhanLopChuyenDen').val()),
                            Buoi1: lopmoi_buoi1,
                            Buoi2: lopmoi_buoi2,
                            KhuVuc: lopmoi_khuvuc
                        },
                        type: 'GET',
                        contentType: 'application/json',
                        success: function (rs) {
                            $("#NgayKetThucLopChuyenDen").val(rs);
                        }
                    })
                }
            },
        }).dxDateBox("instance");
    }
    function KiemTraNgayBatDauChuyenDen() {
        var ngaybd = new Date(Globalize.format($("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('value'), 'yyyy-MM-dd'));
        var ngaychuyen = new Date(Globalize.format($("#NgayChuyen").dxDateBox('instance').option('value'), 'yyyy-MM-dd'));
        if (ngaybd.getTime() < ngaychuyen.getTime()) {
            DevExpress.ui.notify('Ngày bắt đầu phải lớn hơn hoặc bằng ngày chuyển!', 'error', 3000);
            document.querySelector('.dx-toast-warning').style.transform = "translate(720px, 30px)";
            return;
        }
    }
    function TimKiemHocSinh() {
        $('#TimHocVien').modal('show');
        LoadDanhSachHocVien();
    }
    function LoadThongTinHocSinh(hocvien, lophoc) {
        LoadGridLichSuChuyenLop(hocvien);
        $('#TimHocVien').modal('hide');
        $.ajax({
            url: '@Url.Action("LoadDanhSachHocSinhDaXepLop", "DangKyChuyenLop")',
            type: 'GET',
            data: { HocVien: hocvien, LopHoc: lophoc },
            contentType: 'application/json',
            success: function (rs) {
                if (rs.length > 0) {
                    if ($('#TIMKIEMTRUNGTAM').val() != "") {
                        if (rs[0].TrungTam == $('#TIMKIEMTRUNGTAM').val()) {
                            chuyentrungtam = false;
                            $("#btnTimLopHoc").prop("disabled", false);
                            $("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('readOnly', false);
                        }
                        else {
                            chuyentrungtam = true;
                            $("#btnTimLopHoc").prop("disabled", true);
                            $("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('readOnly', true);
                        }
                    }
                    $('#TIMKIEMHOCVIEN').val(rs[0].TenHocVien);
                    $('#DienThoai').val(rs[0].DienThoai);
                    $('#Email').val(rs[0].Email);
                    $('#DiaChi').val(rs[0].DiaChi);
                    $('#TenLop').val(rs[0].TenLop);
                    $('#TrungTam').val(rs[0].TrungTam);
                    $('#ChuongTrinh').val(rs[0].ChuongTrinh);
                    $('#Buoi1').val(rs[0].Buoi1);
                    $('#Buoi2').val(rs[0].Buoi2);
                    $('#SoBuoi').val(rs[0].SobuoiHoc);
                    $('#DonGia').val(rs[0].DonGia.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                    $('#NgayBatDau').val(rs[0].NGAYDUKIENHOC);
                    $('#NgayKetThuc').val(rs[0].NGAYKETHUCHOC);
                    lopcu_dubao = rs[0].A_TH_DUBAO;
                    a_hosokhachhang = rs[0].A_HOSOKHACHHANG;
                    lopcu_kehoach = rs[0].A_KEHOACH;
                    lopcu_trungtam = rs[0].ID_TRUNGTAM == null ? 0 : rs[0].ID_TRUNGTAM;
                    lopcu_sanpham = rs[0].A_SANPHAM == null ? 0 : rs[0].A_SANPHAM;
                    lopcu_khuvuc = rs[0].ID_KHUVUC;
                    lopcu_buoi1 = rs[0].ID_PHUONGTHUC;
                    lopcu_buoi2 = rs[0].ID_CONGCU;
                    lopcu_chietkhau = rs[0].ChietKhau;

                    var d = new Date(rs[0].NGAYKETHUCHOC.split("/").reverse().join("-"));
                    var dd = d.getDate();
                    var mm = d.getMonth() + 1;
                    var yy = d.getFullYear();
                    var newdate = mm + "/" + dd + "/" + yy

                    var bd = new Date(rs[0].NGAYDUKIENHOC.split("/").reverse().join("-"));
                    var ddbd = bd.getDate();
                    var mmbd = bd.getMonth() + 1;
                    var yybd = bd.getFullYear();
                    var newdatebd = mmbd + "/" + ddbd + "/" + yybd;

                    var date = new Date();
                    var bd2 = new Date(Globalize.format(date, 'yyyy-MM-dd').split("/").reverse().join("-"));
                    var ddbd2 = bd.getDate();
                    var mmbd2 = bd.getMonth() + 1;
                    var yybd2 = bd.getFullYear();
                    var newdatebd2 = mmbd + "/" + ddbd + "/" + yybd;

                    $.ajax({
                        url: '@Url.Action("TinhBuoiConLaiKhac", "DangKyChuyenLop")',
                        data: {
                            NgayBatDau: newdatebd,
                            NgayChuyen: newdatebd2,
                            NgayKetThuc: newdate,
                            KhuVuc: lopcu_khuvuc,
                            HocVien: a_hosokhachhang,
                            LopHoc: lopcu_kehoach,
                            Buoi1: lopcu_buoi1,
                            Buoi2: lopcu_buoi2
                        },
                        type: 'GET',
                        contentType: 'application/json',
                        success: function (buoiconlai) {
                            var dg = Number(rs[0].DonGia);
                            var ttcl = dg * buoiconlai;
                            $('#ThanhTienConLai').val(ttcl.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                            $('#SoBuoiConLai').val(buoiconlai);
                            sobuoiconlai = buoiconlai;
                        }
                    })
                }
            }
        })
    }
    function TimKiemLop() {
        $('#TimLopHoc').modal('show');
        LoadDanhSachTimKiemLopHoc();
    }
    function LoadThongTinLopHoc(lophoc) {
        $('#TimLopHoc').modal('hide');
        $.ajax({
            url: '@Url.Action("LoadDanhSachLop", "DangKyChuyenLop")',
            type: 'GET',
            data: { LopHoc: lophoc },
            contentType: 'application/json',
            success: function (rs) {
                if (rs.length > 0) {
                    $('#TIMKIEMLOPHOC').val(rs[0].TENLOP);
                    $('#ChuongTrinhLopChuyenDen').val(rs[0].CHUONGTRINH);
                    $('#Buoi1LopChuyenDen').val(rs[0].BUOI1);
                    $('#Buoi2LopChuyenDen').val(rs[0].BUOI2);
                    $('#DonGiaLopChuyenDen').val(rs[0].DONGIA.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                    var ttcd = Number(rs[0].DONGIA) * Number(sobuoiconlai);
                    $('#ThanhTienLopChuyenDen').val(ttcd.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                    lopmoi_buoi1 = rs[0].ID_PHUONGTHUC;
                    lopmoi_buoi2 = rs[0].ID_CONGCU;
                    lopmoi_sanpham = rs[0].A_SANPHAM == null ? 0 : rs[0].A_SANPHAM;
                    lopmoi_trungtam = rs[0].ID_TRUNGTAM == null ? 0 : rs[0].ID_TRUNGTAM;
                    lopmoi_kehoach = lophoc;
                    lopmoi_chietkhau = rs[0].CHIETKHAU;
                    lopmoi_khuvuc = rs[0].ID_KHUVUC;
                }
            }
        })
    }
    function TimKiemTrungTam() {
        $('#TimTrungTam').modal('show');
        LoadDanhSachTrungTam();
    }

    function LoadThongTinTrungTam(trungtam) {
        $('#TimTrungTam').modal('hide');
        $.ajax({
            url: '@Url.Action("LoadDanhSachTrungTam", "DangKyChuyenLop")',
            type: 'GET',
            data: { TrungTam: trungtam },
            contentType: 'application/json',
            success: function (rs) {
                if (rs.length > 0) {
                    khuvuc = rs[0].ID_KHUVUC;
                    $('#TIMKIEMTRUNGTAM').val(rs[0].TENTRUNGTAM);
                    var trungtam = $('#TrungTam').val();
                    lopmoi_trungtam = rs[0].ID_TRUNGTAM;
                    if (rs[0].TENTRUNGTAM == trungtam) {
                        chuyentrungtam = false;
                        $("#btnTimLopHoc").prop("disabled", false);
                        $("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('readOnly', false);
                    }
                    else {
                        chuyentrungtam = true;
                        $("#btnTimLopHoc").prop("disabled", true);
                        $("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('readOnly', true);
                    }
                }
            }
        })
    }
    function ThemMoi() {
        var elements = document.querySelectorAll('[data-foo]');
        for (var i = 0; i < elements.length; i++) {
            elements[i].value = "";
        }
        $("#NgayKetThucLopChuyenDen").val("");
        $("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('value', null);
        $("#btnLuu").prop("disabled", false);
    }
    function Luu() {
        if ($('#TIMKIEMHOCVIEN').val().trim().length == 0) {
            DevExpress.ui.notify('Chưa chọn học viên!', 'warning', 2000);
            document.querySelector('.dx-toast-warning').style.transform = "translate(720px, 30px)";
            return
        }

        var ngaychuyen = $("#NgayChuyen").dxDateBox('instance').option('value');
        if (ngaychuyen == null || ngaychuyen == "") {
            DevExpress.ui.notify('Ngày dự kiến không được để trống !', 'warning', 2000);
            document.querySelector('.dx-toast-warning').style.transform = "translate(720px, 30px)";
            return
        }
        if ($('#TIMKIEMLOPHOC').val().length > 0) {
            var ngaybd = new Date(Globalize.format($("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('value'), 'yyyy-MM-dd'));
            var ngaychuyen = new Date(Globalize.format($("#NgayChuyen").dxDateBox('instance').option('value'), 'yyyy-MM-dd'));
            if (ngaybd.getTime() < ngaychuyen.getTime()) {
                DevExpress.ui.notify('Ngày bắt đầu phải lớn hơn hoặc bằng ngày chuyển!', 'warning', 3000);
                document.querySelector('.dx-toast-warning').style.transform = "translate(720px, 30px)";
                return;
            }
        }
        var result = DevExpress.ui.dialog.confirm('Bạn có muốn lưu kết quả không?', "Xác nhận");
        result.done(function (dialogResult) {
            if (dialogResult) {
                if (chuyentrungtam == false) {
                    var d = new Date($('#NgayBatDau').val().split("/").reverse().join("-"));
                    var dd = d.getDate();
                    var mm = d.getMonth() + 1;
                    var yy = d.getFullYear();
                    var ngaygiaohang_lopcu = yy + "-" + mm + "-" + dd

                    var d = new Date($('#NgayKetThucLopChuyenDen').val().split("/").reverse().join("-"));
                    var dd = d.getDate();
                    var mm = d.getMonth() + 1;
                    var yy = d.getFullYear();
                    var ngaythanhtoan_lopmoi = yy + "-" + mm + "-" + dd
                    $.ajax({
                        url: '@Url.Action("ChuyenLopCungTrungTam", "DangKyChuyenLop")',
                        data: {
                            A_THDUBAO: lopcu_dubao,
                            J_HOSOKHACHHANG: a_hosokhachhang,
                            LOPCU: lopcu_kehoach,
                            LOPMOI: lopmoi_kehoach,
                            NGAYGIAOHANG_LOPCU: ngaygiaohang_lopcu,
                            NGAYTHANHTOAN_LOPCU: Globalize.format($("#NgayChuyen").dxDateBox('instance').option('value'), 'yyyy-MM-dd'),
                            THANHTIEN_LOPCU: $('#ThanhTienConLai').val().replace(/,/g, ''),
                            THANHTIEN_LOPMOI: $('#ThanhTienLopChuyenDen').val().replace(/,/g, ''),
                            DONGIA_LOPCU: $('#DonGia').val().replace(/,/g, ''),
                            DONGIA_LOPMOI: $('#DonGiaLopChuyenDen').val().replace(/,/g, ''),
                            SOBUOI: $('#SoBuoiConLai').val(),
                            TRUNGTAM_LOPCU: lopcu_trungtam,
                            TRUNGTAM_LOPMOI: lopcu_trungtam, // trungtam moi cung la trung tam cu
                            CHIETKHAU_LOPCU: lopcu_chietkhau,
                            CHIETKHAU_LOPMOI: lopmoi_chietkhau,
                            SANPHAM_LOPCU: lopcu_sanpham,
                            SANPHAM_LOPMOI: lopmoi_sanpham,
                            NGAYGIAOHANG_LOPMOI: Globalize.format($("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('value'), 'yyyy-MM-dd'),
                            NGAYTHANHTOAN_LOPMOI: ngaythanhtoan_lopmoi,
                            GHICHU: ""
                        },
                        success: function (data) {
                            if (!isNaN(data)) {
                                if (data > 0) {
                                    LoadDanhSachChoDuyet();
                                    LoadGridLichSuChuyenLop(a_hosokhachhang);
                                    DevExpress.ui.notify('Cập nhật thành công', 'success', 2000);
                                    document.querySelector('.dx-toast-success').style.transform = "translate(720px, 30px)";
                                    $("#btnLuu").prop("disabled", true);
                                }
                            }
                            else {
                                DevExpress.ui.notify('Chưa cập nhật được', 'error', 2000);
                                document.querySelector('.dx-toast-error').style.transform = "translate(720px, 30px)";
                            }
                        }
                    })
                }
                else {
                    var d = new Date($('#NgayBatDau').val().split("/").reverse().join("-"));
                    var dd = d.getDate();
                    var mm = d.getMonth() + 1;
                    var yy = d.getFullYear();
                    var ngaygiaohang_lopcu = yy + "-" + mm + "-" + dd
                    $.ajax({
                        url: '@Url.Action("ChuyenTrungTam", "DangKyChuyenLop")',
                        data: {
                            A_THDUBAO: lopcu_dubao,
                            J_HOSOKHACHHANG: a_hosokhachhang,
                            LOPCU: lopcu_kehoach,
                            NGAYGIAOHANG_LOPCU: ngaygiaohang_lopcu,
                            NGAYTHANHTOAN_LOPCU: Globalize.format($("#NgayChuyen").dxDateBox('instance').option('value'), 'yyyy-MM-dd'),
                            THANHTIEN_LOPCU: $('#ThanhTienConLai').val().replace(/,/g, ''),
                            SOBUOI: $('#SoBuoiConLai').val(),
                            DONGIA_LOPCU: $('#DonGia').val().replace(/,/g, ''),
                            TRUNGTAMDI: lopcu_trungtam,
                            TRUNGTAMDEN: lopmoi_trungtam,
                            CHIETKHAU_LOPCU: lopcu_chietkhau,
                            SANPHAM_LOPCU: lopcu_sanpham,
                            GHICHU: ""
                        },
                        success: function (data) {
                            if (!isNaN(data)) {
                                if (data > 0) {
                                    LoadDanhSachChoDuyet();
                                    LoadGridLichSuChuyenLop(a_hosokhachhang);
                                    DevExpress.ui.notify('Cập nhật thành công', 'success', 2000);
                                    document.querySelector('.dx-toast-success').style.transform = "translate(720px, 30px)";
                                    $("#btnLuu").prop("disabled", true);
                                }
                            }
                            else {
                                DevExpress.ui.notify('Chưa cập nhật được', 'error', 2000);
                                document.querySelector('.dx-toast-error').style.transform = "translate(720px, 30px)";
                            }
                        }
                    })
                }
            }
            else { }
        });
    }
    function LoadDanhSachHocVien() {
        $.ajax({
            url: '@Url.Action("GetDanhSachHocSinhDaXepLop", "DangKyChuyenLop")',
            type: 'GET',
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridDanhSachHocSinhDaXepLop").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                        {
                            caption: "Đăng ký", alignment: 'center',
                            width: 100,
                            cellTemplate: function (container, options) {
                                var dt = options.data;
                                $('<a href="javascript:" onclick="LoadThongTinHocSinh(' + dt.A_HOSOKHACHHANG + ',' + dt.A_KEHOACH + ')"  class="text-green"><b>...</b></a>').appendTo(container);
                            }
                        },
                          {
                              dataField: "MaDangky",
                              caption: "Mã đăng ký",
                              width: 120,
                          }, {
                              caption: "Mã học viên",
                              dataField: "MaHocVien",
                              width: 180,
                          }, {
                              caption: "Tên học viên",
                              dataField: "TenHocVien",
                              width: 200,
                          },
                           {
                               caption: "Mã Effect",
                               dataField: "ma_effect",
                               width: 200,
                           }, {
                               caption: "Mã LMS",
                               dataField: "ma_lms",
                               width: 200,
                           }, {
                               dataField: "TenLop",
                               caption: "Tên lớp",
                               width: 250,
                           },
                           {
                               dataField: "TrungTam",
                               caption: "Trung tâm",
                               width: 200,
                           },
                          {
                              dataField: "ChuongTrinh",
                              caption: "Chương trình",
                              width: 120,
                          }, {
                              dataField: "SobuoiHoc",
                              caption: "Số buổi học",
                              width: 120,
                          },
                          {
                              dataField: "DonGia",
                              caption: "Đơn giá",
                              width: 120,
                              dataType: "number",
                              format: 'decimal fixedPoint'
                          },
                          {
                              caption: "Buổi 1",
                              dataField: "Buoi1",
                              width: 100,
                          },
                          {
                              caption: "Buổi 2",
                              dataField: "Buoi2",
                              width: 120,
                          },
                          {
                              caption: "Ngày BĐ học",
                              dataField: "NGAYDUKIENHOC",
                              width: 120,
                          },
                          {
                              caption: "Ngày KT học",
                              dataField: "NGAYKETHUCHOC",
                              width: 120,
                          },
                          {
                              caption: "Trạng thái học",
                              dataField: "TrangThaiHoc",
                              width: 120,
                          },
                    ],

                }).dxDataGrid('instance');
            },
            //error: function (a, b, c) {
            //    DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            //}
        });
    }
    function LoadDanhSachTimKiemLopHoc() {
        $.ajax({
            url: '@Url.Action("GetDanhSachLopHoc", "DangKyChuyenLop")',
            type: 'GET',
            data: { TrungTam: lopmoi_trungtam, LopCu: lopcu_kehoach },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridDanhSachHocLopHoc").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                        {
                            caption: "Chọn", alignment: 'center',
                            width: 100,
                            cellTemplate: function (container, options) {
                                var dt = options.data;
                                $('<a href="javascript:" onclick="LoadThongTinLopHoc(\'' + dt.A_KEHOACH + '\')"  class="text-green"><b>...</b></a>').appendTo(container);
                            }
                        },
                          {
                              dataField: "TENLOP",
                              caption: "Tên lớp",
                              width: 250,
                          }, {
                              caption: "Mã trung tâm",
                              dataField: "TRUNGTAM",
                              width: 250,
                          }, {
                              caption: "Số buổi",
                              dataField: "SOBUOI",
                              width: 120,
                          }, {
                              dataField: "BUOI1",
                              caption: "Buổi 1",
                              width: 100,
                          },
                           {
                               dataField: "BUOI2",
                               caption: "Buổi 2",
                               width: 100,
                           },
                          {
                              dataField: "NGAYBATDAU",
                              caption: "Ngày bắt đầu",
                              width: 120,
                          }, {
                              dataField: "CHUONGTRINH",
                              caption: "Chương trình",
                              width: 200,
                          },
                          {
                              dataField: "TENNHOMSANPHAM",
                              caption: "Nhóm sản phẩm",
                              width: 120,
                          },
                          {
                              caption: "Đơn giá",
                              dataField: "DONGIA",
                              width: 120,
                          },
                    ],

                }).dxDataGrid('instance');
            },
            error: function (a, b, c) {
                DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            }

        });
    }

    function LoadDanhSachTrungTam() {
        $.ajax({
            url: '@Url.Action("GetDanhSachTrungTam", "DangKyChuyenLop")',
            type: 'GET',
            data: { TenTrungTam: "" },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridDanhSachTrungTam").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                        {
                            caption: "Chọn", alignment: 'center',
                            width: 100,
                            cellTemplate: function (container, options) {
                                var dt = options.data;
                                $('<a href="javascript:" onclick="LoadThongTinTrungTam(\'' + dt.ID_TRUNGTAM + '\')"  class="text-green"><b>...</b></a>').appendTo(container);
                            }
                        },
                          {
                              dataField: "TENTRUNGTAM",
                              caption: "Trung tâm",
                              width: 250,
                          }, {
                              caption: "Vùng",
                              dataField: "tenvung",
                              width: 120,
                          }, {
                              caption: "Địa chỉ",
                              dataField: "DIACHITRUNGTAM",
                              width: 120,
                          }, {
                              dataField: "DIENTHOAITRUNGTAM",
                              caption: "Điện thoại",
                              width: 100,
                          },
                    ],

                }).dxDataGrid('instance');
            },
            error: function (a, b, c) {
                DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            }

        });
    }

    function LoadGridLichSuChuyenLop(hocvien) {
        $.ajax({
            url: '@Url.Action("LoadLichSuChuyenLop", "DangKyChuyenLop")',
            type: 'GET',
            data: { HocVien: hocvien },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridLichSuChuyenLop").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 20, 50],
                        showInfo: true
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    selection: {
                        mode: "single"
                    },
                    columns: [{
                        dataField: "STT",
                        caption: "STT",
                        width: 50,
                    }, {
                        dataField: "MAHOCVIEN",
                        caption: "Mã học viên",
                        width: 200,
                    }, {
                        caption: "Tên học viên",
                        dataField: "TENHOCVIEN",
                        width: 230,
                    }, {
                        caption: "Ngày chuyển",
                        dataField: "NGAYCHUYEN",
                        width: 120,
                    }, {
                        caption: "Người chuyển",
                        dataField: "TAIKHOANNGUOICHUYEN",
                        width: 120,
                    }, {
                        caption: "Hình thức chuyển",
                        dataField: "HINHTHUCCHUYEN",
                        width: 200,
                    }, {
                        caption: "Số buổi chuyển",
                        dataField: "SOBUOICHUYEN",
                        width: 120,
                    }, {
                        caption: "Tiền chuyển",
                        dataField: "TIENCHUYEN",
                        width: 120,
                        dataType: "number",
                        format: 'decimal fixedPoint'
                    }, {
                        caption: "Trung tâm đi",
                        dataField: "TRUNGTAMDI",
                        width: 250,
                    }, {
                        caption: "Trung tâm đến",
                        dataField: "TRUNGTAMDEN",
                        width: 250,
                    }, {
                        caption: "Lớp chuyển đi",
                        dataField: "LOPCHUYENDI",
                        width: 200,
                    }, {
                        caption: "Lớp chuyển đến",
                        dataField: "LOPCHUYENDEN",
                        width: 200,
                    }, {
                        caption: "Chương trình đi",
                        dataField: "CHUONGTRINHDI",
                        width: 200,
                    }, {
                        caption: "Chương trình đến",
                        dataField: "CHUONGTRINHDEN",
                        width: 200,
                    },
                    ],
                    onCellClick: function (e) {
                        var component = e.component,
                            prevClickTime = component.lastClickTime;
                        component.lastClickTime = new Date();
                        if (prevClickTime && (component.lastClickTime - prevClickTime < 300)) {
                            var dataGrid2 = $('#gridLichSuChuyenLop').dxDataGrid('instance');
                            var row = dataGrid2.getSelectedRowsData();
                            LoadThongTinChiTietLichSu(row[0].A_TH_DUBAO);
                        }
                        else {
                            ss = [];
                        }
                    }
                }).dxDataGrid('instance');
            },
            //error: function (a, b, c) {
            //    DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            //}
        });
    }
    function LoadDanhSachChoDuyet() {
        $.ajax({
            url: '@Url.Action("LoadLichSuChuyenLop", "DangKyChuyenLop")',
            type: 'GET',
            data: { HocVien: 0 },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridDanhSachChoDuyet").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 20, 50],
                        showInfo: true
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    selection: {
                        mode: "single"
                    },
                    columns: [{
                        dataField: "STT",
                        caption: "STT",
                        width: 50,
                    }, {
                        dataField: "MAHOCVIEN",
                        caption: "Mã học viên",
                        width: 200,
                    }, {
                        caption: "Tên học viên",
                        dataField: "TENHOCVIEN",
                        width: 230,
                    }, {
                        caption: "Ngày chuyển",
                        dataField: "NGAYCHUYEN",
                        width: 120,
                    }, {
                        caption: "Người chuyển",
                        dataField: "TAIKHOANNGUOICHUYEN",
                        width: 120,
                    }, {
                        caption: "Hình thức chuyển",
                        dataField: "HINHTHUCCHUYEN",
                        width: 200,
                    }, {
                        caption: "Số buổi chuyển",
                        dataField: "SOBUOICHUYEN",
                        width: 120,
                    }, {
                        caption: "Tiền chuyển",
                        dataField: "TIENCHUYEN",
                        width: 120,
                        dataType: "number",
                        format: 'decimal fixedPoint'
                    }, {
                        caption: "Trung tâm đi",
                        dataField: "TRUNGTAMDI",
                        width: 250,
                    }, {
                        caption: "Trung tâm đến",
                        dataField: "TRUNGTAMDEN",
                        width: 250,
                    }, {
                        caption: "Lớp chuyển đi",
                        dataField: "LOPCHUYENDI",
                        width: 250,
                    }, {
                        caption: "Lớp chuyển đến",
                        dataField: "LOPCHUYENDEN",
                        width: 250,
                    }, {
                        caption: "Chương trình đi",
                        dataField: "CHUONGTRINHDI",
                        width: 200,
                    }, {
                        caption: "Chương trình đến",
                        dataField: "CHUONGTRINHDEN",
                        width: 200,
                    }, {
                        caption: "Tình trạng duyệt",
                        dataField: "TENDUYET",
                        width: 150,
                    }, {
                        caption: "Ý kiến bổ sung",
                        dataField: "YKIENBOSUNG",
                        width: 200,
                    },
                    ],
                    onCellClick: function (e) {
                        var component = e.component,
                            prevClickTime = component.lastClickTime;
                        component.lastClickTime = new Date();
                        if (prevClickTime && (component.lastClickTime - prevClickTime < 300)) {
                            var dataGrid2 = $('#gridDanhSachChoDuyet').dxDataGrid('instance');
                            var row = dataGrid2.getSelectedRowsData();
                            LoadThongTinChiTietLichSu(row[0].A_TH_DUBAO);
                        }
                        else {
                            ss = [];
                        }
                    }
                }).dxDataGrid('instance');
            },
            //error: function (a, b, c) {
            //    DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            //}
        });
    }
    function LoadThongTinChiTietLichSu(a_th_dubao) {
        a_thdubao = a_th_dubao;
        $.ajax({
            url: '@Url.Action("LoadChiTietLichSu", "DangKyChuyenLop")',
            type: 'GET',
            data: { DUBAO: a_th_dubao },
            contentType: 'application/json',
            success: function (rs) {
                if (rs.length > 0) {

                    xemlichsu = true;
                    $('#TIMKIEMHOCVIEN').val(rs[0].TENHOCVIEN);
                    $('#DienThoai').val(rs[0].DIENTHOAI);
                    $('#Email').val(rs[0].EMAIL);
                    $('#DiaChi').val(rs[0].DIACHI);

                    //Thong tin lop cu
                    $("#NgayChuyen").dxDateBox('instance').option('value', rs[0].NGAYCHUYEN);
                    $('#TenLop').val(rs[0].TENKEHOACH_LOPCHUYEN);
                    $('#TrungTam').val(rs[0].TENTRUNGTAM_LOPCHUYEN);
                    $('#ChuongTrinh').val(rs[0].TENCHUONGTRINH_LOPCHUYEN);
                    $('#Buoi1').val(rs[0].BUOI1_LOPCHUYEN);
                    $('#Buoi2').val(rs[0].BUOI2_LOPCHUYEN);
                    $('#SoBuoi').val(rs[0].TONGSOBUOI);
                    $('#SoBuoiConLai').val(rs[0].SOBUOI_LOPCHUYEN);
                    $('#DonGia').val(rs[0].DONGIA_LOPCHUYEN.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                    $('#ThanhTienConLai').val(rs[0].THANHTIEN_LOPCHUYEN.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                    $('#NgayBatDau').val(rs[0].NGAYBATDAU_LOPCHUYEN);
                    $('#NgayKetThuc').val(rs[0].NGAYKETTHUC_LOPCHUYEN);


                    //Thong tin lop moi
                    $('#TIMKIEMTRUNGTAM').val(rs[0].TENTRUNGTAM_LOPNHAN);
                    if (rs[0].TENKEHOACH_LOPCHUYEN == rs[0].TENKEHOACH_LOPNHAN) {  //chuyển trung tâm
                        $("#TIMKIEMLOPHOC").prop("disabled", true);
                    }
                    else {  //chuyển lớp học
                        $('#TIMKIEMLOPHOC').val(rs[0].TENKEHOACH_LOPNHAN);
                        $('#ChuongTrinhLopChuyenDen').val(rs[0].TENCHUONGTRINH_LOPNHAN);
                        $('#Buoi1LopChuyenDen').val(rs[0].BUOI1_LOPNHAN);
                        $('#Buoi2LopChuyenDen').val(rs[0].BUOI2_LOPNHAN);
                        $('#SoBuoiNhanLopChuyenDen').val(rs[0].SOBUOI_LOPNHAN);
                        $('#DonGiaLopChuyenDen').val(rs[0].DONGIA_LOPNHAN.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                        $('#ThanhTienLopChuyenDen').val(rs[0].THANHTIEN_LOPNHAN.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
                        $("#NgayBatDauLopChuyenDen").dxDateBox('instance').option('value', rs[0].NGAYBATDAU_LOPNHAN);
                        $('#NgayKetThucLopChuyenDen').val(rs[0].NGAYKETTHUC_LOPNHAN);
                    }
                    xemlichsu = false;
                    $("#btnLuu").prop("disabled", true);
                }
            }
        })
    }
    function ConvertDate(obj) {
        var lstngay = obj.split("/");
        return lstngay[2] + "-" + lstngay[0] + "-" + lstngay[1];
    }
</script>

<script>
    function DuyetTiepNhanChuyenLop() {
        if (a_thdubao > 0) {
            $.getJSON('/DangKyChuyenLop/LoadNguoiDung', $.param({ DuBao: a_thdubao }), function (rs) {
                if (rs.TENDTTC == undefined) {
                    $('#TenNguoiDung').val(rs);
                }
                else {
                    $('#TenNguoiDung').val(rs.TENDTTC);
                }
                $('#GhiChuDuyet').val(rs.YKIENBOSUNG);
                $("#YKienDuyet").dxSelectBox('instance').option('value', rs.ID_DUYET);
                if (rs.ID_DUYET > 0) {
                    $("#LuuDuyet").prop("disabled", true);
                }
                else {
                    $("#LuuDuyet").prop("disabled", false);
                }
            })
            LoadDanhSachDuyetHocVien(a_thdubao);
            $('#DuyetTiepNhan').modal('show');
        }
        else {
            DevExpress.ui.notify('Chưa chọn học viên để duyệt', 'error', 2000);
            return;
        }
    }
    function LoadDanhSachDuyetHocVien(obj) {
        $.ajax({
            url: '@Url.Action("GetDanhSachLichSuDuyet", "DangKyChuyenLop")',
            type: 'GET',
            data: { DuBao: obj },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridDanhSachLichSuDuyet").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                        {
                            caption: "Ngày duyệt",
                            dataField: "NGAYDUYET",
                            width: 200,
                        }, {
                            caption: "Người duyệt",
                            dataField: "TENDTTC",
                            width: 200,
                        }, {
                            dataField: "TENDUYET",
                            caption: "Trạng thái",
                            width: 200,
                        },
                        {
                            dataField: "YKIENBOSUNG",
                            caption: "Ý kiến duyệt",
                            width: 200,
                        },
                    ],

                }).dxDataGrid('instance');
            },
            error: function (a, b, c) {
                DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            }

        });
    }
    function LoadDanhMucDuyet() {
        $.ajax({
            url: '@Url.Action("DM_DuyetThucHien", "DanhMuc")',
            type: 'GET',
            contentType: 'application/json',
            success: function (rs) {
                $("#YKienDuyet").dxSelectBox({
                    items: rs,
                    showPopupTitle: false,
                    displayExpr: "TENDUYET",
                    valueExpr: "ID_DUYET",
                    searchEnabled: true,
                    onValueChanged: function (e) {
                        id_duyet = e.value;
                    },
                });
            }
        })
    }
    function LuuDuyetTiepNhanChuyenLop() {
        var formData = new FormData();
        formData.append("A_THDUBAO", a_thdubao);
        formData.append("IDDuyet", $("#YKienDuyet").dxSelectBox('instance').option('value'));
        formData.append("NoiDung", $('#GhiChuDuyet').val());
        var result = DevExpress.ui.dialog.confirm('Bạn có chắc chắn lưu không?', "Confirm changes");
        result.done(function (dialogResult) {
            if (dialogResult) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("SaveDuyetChuyenLop", "DangKyChuyenLop")',
                    dataType: 'json',
                    contentType: false,
                    processData: false,
                    data: formData,
                    beforeSend: function () { window.parent.$('#loading').show(); },
                    success: function (data) {
                        window.parent.$("#loading").fadeOut("fast");
                        if (data > 0) {
                            LoadDanhSachDuyetHocVien(a_thdubao);
                            DevExpress.ui.notify('Cập nhật thành công', 'success', 2000);
                            $("#btnLuu").prop("disabled", true);
                        }
                        else {
                            DevExpress.ui.notify('Chưa cập nhật được', 'error', 2000);
                        }
                    }
                })
            }
        });
    }
</script>

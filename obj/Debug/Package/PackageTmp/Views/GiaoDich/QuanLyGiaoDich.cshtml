
@{
    ViewBag.Title = "ChamSocKhachHang";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<input type="hidden" value="@ViewBag.NguoiGiaoDich" id="Account" />
<div class="box box-danger">
    <div class="box-header with-border">
        <h3 class="box-title">Chăm sóc khách hàng</h3>
    </div>
    <!-- /.box-header -->
    <!-- form start -->
    <form class="form-horizontal">
        <!--Menu-->
        <div class="margin text-right">
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger" onclick="ThemMoi()">Thêm mới</button></div>
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger" id="btn_Luu" onclick="Luu()">Lưu</button></div>
        </div>
        <!--/Menu-->
        <div class="box-body">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-left:0px!important">Tên học sinh</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="text" class="form-control" data-foo id="TIMKIEMTENHOCSINH" readonly>
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-block btn-danger" onclick="TimKiemHocSinh()">Tìm kiếm</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-left:0px!important">Mã học sinh</label>
                    <div class="col-sm-4">
                        <input type="text" id="MaHocVien" data-foo readonly class="form-control">
                    </div>
                    <label class="col-sm-2 control-label" style="padding-right: 0px!important">Mã LMS</label>
                    <div class="col-sm-4">
                        <input type="text" id="MaLMS" data-foo readonly class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Địa chỉ</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" data-foo readonly id="DiaChi" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Phụ huynh</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" data-foo readonly id="PhuHuynh" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Di động</label>
                    <div class="col-sm-4">
                        <input type="text" id="DiDong" data-foo readonly class="form-control">
                    </div>
                    <label class="col-sm-2 control-label" style="padding-right: 0px!important">Email</label>
                    <div class="col-sm-4">
                        <input type="text" id="EmailPH" data-foo readonly class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Trung tâm</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" data-foo readonly id="TrungTam" placeholder="">
                    </div>
                </div>
                
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding: 7px 0px!important">Ngày làm việc</label>
                    <div class="col-sm-4">
                        <div id="NgayGiaoDich" style="width:100%"></div>
                    </div>
                    <label class="col-sm-3 control-label">Người thực hiện</label>
                    <div class="col-sm-3">
                        <input type="text" id="NguoiGiaoDich" data-foo readonly class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-right:0px">Phương thức<span>(*)</span></label>
                    <div class="col-sm-4">
                        <div id="PhuongThuc" style="width:100%"></div>
                        <span class="error" id="lbl_phuongthuc" hidden>This field is required</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">Nôi dung công việc<span>(*)</span></label>
                    <div class="col-sm-10">
                        <textarea class="form-control" rows="3" id="NoiDung" data-foo placeholder="Nội dung công việc..."></textarea>
                        <span class="error" id="lbl_ndcv" hidden>This field is required</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Các điểm thống nhất</label>
                    <div class="col-sm-10">
                        <textarea class="form-control" rows="4" id="ThongNhat" data-foo placeholder="Các điểm thống nhất..."></textarea>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.box-body -->
    </form>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="panel-heading">
            <h6 class="panel-title">LỊCH SỬ</h6>
        </div>
        <div class="panel-body" style="padding: 0px;">
            <form action="#" class="form-horizontal">
                <div id="gridContainer2"></div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="TimHocVien" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-red">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Danh sách học sinh</h4>
            </div>
            <div class="modal-body">
                <div id="gridDanhSachHocSinh">
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<div class="modal fade" id="fr_Confirm" style="display: none;width:500px;height:200px;margin-left:500px;margin-top:200px">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-red">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Cảnh báo</h4>
            </div>
            <div class="modal-body">
                <label>Bạn có chắc muốn lưu lại không?</label></br>
                <div class="btn-group" style="margin-left:100px"><button type="button" class="btn btn-block btn-danger" onclick="Yes()">Yes</button></div>
                <div class="btn-group" style="margin-left:250px"><button type="button" class="btn btn-block btn-danger" onclick="No()">No</button></div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<style>
    .error {
        display: none;
        margin-left: 10px;
        color: red;
    }
</style>
<script>
    var a_hosokhachhang=0; var now = new Date();
    $(document).ready(function () {
        $('#btn_Luu').prop('disabled', false);
        LoadPhuongThuc();
       // LoadTiemNang();
        $("#NgayGiaoDich").dxDateBox({
            value: now,
            formatString: 'dd/MM/yyyy',
            onValueChanged: function (data) {
            },
        }).dxDateBox("instance");
        LoadGridHocSinh(0);
        $('#NguoiGiaoDich').val($('#Account').val());
    });
    function LoadPhuongThuc()
    {
        $.ajax({
            url: '@Url.Action("GetPhuongThuc", "DanhMuc")',
            type: 'GET',
            contentType: 'application/json',
            success: function (rs) {
                $("#PhuongThuc").dxSelectBox({
                    items: rs,
                    showPopupTitle: false,
                    displayExpr: "TENTINHTRANGGD",
                    valueExpr: "ID_TINHTRANGGD",
                    searchEnabled: true,
                    onValueChanged: function (e) {
                    },
                });
            }
        })
    }
    @*function LoadTiemNang() {
        $.ajax({
            url: '@Url.Action("GetTiemNang", "DanhMuc")',
            type: 'GET',
            contentType: 'application/json',
            success: function (rs) {
                $("#TiemNang").dxSelectBox({
                    items: rs,
                    showPopupTitle: false,
                    displayExpr: "TENTIEMNANG",
                    valueExpr: "ID_TIEMNANG",
                    searchEnabled: true,
                    onValueChanged: function (e) {
                    },
                });
            }
        })
    }*@
    function TimKiemHocSinh()
    {
        $('#TimHocVien').modal('show');
        LoadDanhSachHocVien();
    }
    function LoadDanhSachHocSinh(hocvien)
    {
        $('#TimHocVien').modal('hide');
        $.ajax({
            url: '@Url.Action("LoadDanhSachHocSinh", "GiaoDich")',
            type: 'GET',
            data: { HocVien: hocvien },
            contentType: 'application/json',
            success: function (rs) {
                if (rs.length > 0)
                {
                    $('#TIMKIEMTENHOCSINH').val(rs[0].tenhocsinh);
                    $('#MaHocVien').val(rs[0].MAHOCSINH);
                    $('#MaLMS').val(rs[0].ma_lms);
                    $('#DiaChi').val(rs[0].DIACHI);
                    $('#PhuHuynh').val(rs[0].TENBO);
                    $('#DiDong').val(rs[0].dienthoai);
                    $('#EmailPH').val(rs[0].EMAIL);
                    $('#TrungTam').val(rs[0].TENTRUNGTAM);
                    a_hosokhachhang = rs[0].A_HOSOKHACHHANG;
                }
            }
        })
        LoadGridHocSinh(hocvien);
    }
    function Luu() {
        if (a_hosokhachhang == 0) {
            DevExpress.ui.notify('Bạn chưa chọn học sinh', 'warning', 2000);
        } else {
            if ($('#NoiDung').val() == "") {
                $('#lbl_ndcv').show();
            } else {
                $('#lbl_ndcv').hide();
            }
            if ($('#PhuongThuc').dxSelectBox('instance').option('value') == null) {
                $('#lbl_phuongthuc').show();
            } else {
                $('#lbl_phuongthuc').hide();
            }
            if ($('#NoiDung').val() == '' || $('#PhuongThuc').dxSelectBox('instance').option('value') == null) {
                //DevExpress.ui.notify('Các thông tin có dấu (*) bắt buộc phải nhập', 'warning', 2000);
            } else {
                var result = DevExpress.ui.dialog.confirm('Bạn có muốn lưu kết quả không?', "Xác nhận thay đổi");
                result.done(function (dialogResult) {
                    if (dialogResult) {
                        $('#btn_Luu').prop('disabled', true);
                        $.ajax({
                            url: '@Url.Action("SaveGiaoDich", "GiaoDich")',
                            data: { J_HOSOKHACHHANG: a_hosokhachhang, NGAYGIAODICH: Globalize.format($("#NgayGiaoDich").dxDateBox('instance').option('value'), 'yyyy-MM-dd'), ID_TINHTRANGGD: $('#PhuongThuc').dxSelectBox('instance').option('value'), NOIDUNG_GIAODICH: $('#NoiDung').val(), CHOTCACDIEMTHONGNHAT: $('#ThongNhat').val() },
                            success: function (data) {
                                if (!isNaN(data)) {
                                    if (data > 0) {
                                        DevExpress.ui.notify('Cập nhật thành công', 'success', 2000);
                                        LoadGridHocSinh(a_hosokhachhang);
                                    }
                                }
                                else {
                                    DevExpress.ui.notify('Chưa cập nhật được', 'error', 2000);
                                }
                            }
                        })
                    }
                    else {
                    }
                });
            }
        }
    }
    function ThemMoi()
    {
        var elements = document.querySelectorAll('[data-foo]');
        for (var i = 0; i < elements.length; i++) {
            elements[i].value = "";
        }
        $("#NgayGiaoDich").dxDateBox('instance').option('value', null);
        $("#PhuongThuc").dxSelectBox('instance').option('value', null);
        $('#btn_Luu').prop('disabled', false);
        $("#NgayGiaoDich").dxDateBox({
            value: now,
            formatString: 'dd/MM/yyyy',
            onValueChanged: function (data) {
            },
        }).dxDateBox("instance");
        $('#NguoiGiaoDich').val($('#Account').val());
        LoadGridHocSinh(0);
    }
    function LoadDanhSachHocVien()
    {
        $.ajax({
            url: '@Url.Action("GetDanhSachHocSinh", "GiaoDich")',
            type: 'GET',
            data: { HocVien: null },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridDanhSachHocSinh").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 20, 50],
                        showInfo: true
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                        {
                            caption: "Chọn", alignment: 'center',
                            width: 50,
                            cellTemplate: function (container, options) {
                                var dt = options.data;
                                $('<a href="javascript:" onclick="LoadDanhSachHocSinh(\'' + dt.A_HOSOKHACHHANG + '\')"  class="text-green"><b>...</b></a>').appendTo(container);
                            }
                        },
                          {
                              dataField: "MaHocSinh",
                              caption: "Mã học sinh",
                              width: 120,
                          }, {
                              caption: "Mã Effect",
                              dataField: "MaEffect",
                              width: 120,
                          }, {
                              caption: "Mã LMS",
                              dataField: "MaLMS",
                              width: 120,
                          }, {
                              dataField: "TenHocSinh",
                              caption: "Tên học sinh",
                              width: 200,
                          },
                           {
                               dataField: "TrungTam",
                               caption: "Trung tâm",
                               width: 200,
                           },
                          {
                              dataField: "Ngaysinh",
                              caption: "Ngày sinh",
                              width: 120,
                          }, {
                              dataField: "DiaChi",
                              caption: "Địa chỉ",
                              width: 200,
                          },
                          {
                              dataField: "QuanHuyen",
                              caption: "Quận huyện",
                              width: 120,
                          },
                          {
                              caption: "Tỉnh thành",
                              dataField: "TinhThanh",
                              width: 120,
                          },
                          {
                              caption: "Giới tính",
                              dataField: "GioiTinh",
                              width: 120,
                          },
                          {
                              caption: "Tên bố",
                              dataField: "TenBo",
                              width: 200,
                          },
                          {
                              caption: "Điện thoại",
                              dataField: "DiDong",
                              width: 120,
                          },
                          {
                              caption: "Email",
                              dataField: "Email",
                              width: 120,
                          },
                          {
                              caption: "Mã anh em cùng học",
                              dataField: "MaAECungHoc",
                              width: 120,
                          },
                          {
                              caption: "Sale phụ trách",
                              dataField: "SaleQuanLy",
                              width: 120,
                          },
                          {
                              caption: "Mã CM phụ trách",
                              dataField: "CM_QuanLy",
                              width: 120,
                          },
                          {
                              caption: "Loại học sinh",
                              dataField: "LoaiHocSinh",
                              width: 120,
                          },
                    ],

                }).dxDataGrid('instance');
            },
            error: function (a, b, c) {
                DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            }

        });
    }
    function LoadGridHocSinh(hv)
    {
        $.ajax({
            url: '@Url.Action("LoadHocSinhGiaoDich", "GiaoDich")',
            type: 'GET',
            data: { HocVien: hv },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridContainer2").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 20, 50],
                        showInfo: true
                    },
                    selection: {
                        mode: 'multiple'
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                          {
                              caption: "Ngày làm việc",
                              dataField: "NGAYGIAODICH",
                              datatype: "date",
                              alignment: "right",
                              width: 200
                          }, {
                              dataField: "NGUOIGIAODICH",
                              caption: "Người thực hiện",
                              width: 250,
                          },  {
                              caption: "Phương thức",
                              dataField: "PHUONGTHUC",
                              width: 300,
                          },
                          //{
                          //    dataField: "TIEMNANG",
                          //    caption: "Tiềm năng",
                          //    width: 200,
                          //},
                          {
                              dataField: "NOIDUNG_GIAODICH",
                              caption: "Nội dung công việc",
                              width: 500,
                          },
                          //{
                          //    dataField: "CHOTCACDIEM_THONGNHAT",
                          //    caption: "Các điểm thống nhất",
                          //    width: 400,
                          //},
                    ],
                    onSelectionChanged: function (selectedItems) {
                        var data = selectedItems.selectedRowsData[0];
                        if (data) {
                            $('#btn_Luu').prop('disabled', true);
                            $.ajax({
                                url: '@Url.Action("ChiTietGiaoDich", "GiaoDich")',
                                data: { HocVien: hv, GiaoDich: data.A_TH_GIAODICH },
                                success: function (rs) {
                                    $("#NgayGiaoDich").dxDateBox('instance').option('value', rs[0].NGAYGIAODICH2);
                                    $('#NguoiGiaoDich').val(rs[0].TAIKHOAN);
                                    $("#PhuongThuc").dxSelectBox('instance').option('value', rs[0].ID_TINHTRANGGD);
                                    $('#NoiDung').val(rs[0].NOIDUNG_GIAODICH);
                                    $('#ThongNhat').val(rs[0].CHOTCACDIEM_THONGNHAT);
                                }
                            })
                        }
                    }
                }).dxDataGrid('instance');
            },
            error: function (a, b, c) {
                DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            }

        });
    }
</script>
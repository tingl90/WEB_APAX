
@{
    ViewBag.Title = "ChiTietTaiPhi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="box box-danger">
    <div class="box-header with-border">
        <h3 class="box-title">Tái phí</h3>
    </div>
    <!-- /.box-header -->
    <!-- form start -->
    <form class="form-horizontal">
        <!--Menu-->
        <div class="margin text-right">
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger" onclick="ThemMoiTaiPhi()">Thêm mới</button></div>
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger" onclick="ThuTaiPhi()">Thu tiền</button></div>
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger" onclick="Xoa()">Xóa</button></div>
            <div class="btn-group"><button type="button" class="btn btn-block btn-danger">Print</button></div>
        </div>
        <!--/Menu-->
        <div class="box-body" style="margin-top: -30px">
            <div class="col-md-6">
                <div class="form-group">
                    <h5><label class="col-sm-12 control-label text-bold" style="text-align:left">THÔNG TIN HỌC VIÊN - LỚP ĐANG HỌC</label></h5>
                </div>
                @*<div class="form-group">
                    <h5><label class="col-sm-12 control-label text-bold" style="text-align:left">THÔNG TIN LỚP ĐANG HỌC</label></h5>
                </div>*@
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-left:0px">Tên học viên</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="text" class="form-control" id="TIMKIEMHOCVIEN" readonly>
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-block btn-danger" onclick="TimKiemHocSinh()">Tìm kiếm</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Mã HV</label>
                    <div class="col-sm-4">
                        <input type="text" id="MaHocVien" readonly class="form-control">
                    </div>
                    <label class="col-sm-2 control-label">Mã LMS</label>
                    <div class="col-sm-4">
                        <input type="text" id="MaLMS" readonly class="form-control">
                    </div>
                </div>                
                @*<div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-left:0px">Tên học viên</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="TenHocVien" placeholder="">
                    </div>
                </div>*@
                <div class="form-group">
                    <label class="col-sm-2 control-label">Tên lớp</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="TenLop" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Trung tâm</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="TrungTam" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px">Chương trình</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" readonly id="ChuongTrinh" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Buổi 1</label>
                    <div class="col-sm-4">
                        <input type="text" id="Buoi1" readonly class="form-control">
                    </div>
                    <label class="col-sm-2 control-label">Buổi 2</label>
                    <div class="col-sm-4">
                        <input type="text" id="Buoi2" readonly class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding-left: 0px;">Số buổi học</label>
                    <div class="col-sm-4">
                        <input type="text" id="SoBuoiHoc" readonly class="form-control">
                    </div>
                    <label class="col-sm-2 control-label" style="padding:7px 0px!important">Số buổi còn lại</label>
                    <div class="col-sm-4">
                        <input type="text" id="SoBuoiConLai" readonly class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" style="padding:7px 0px;">Ngày bắt đầu</label>
                    <div class="col-sm-4">
                        <input type="text" id="NgayBatDau" readonly class="form-control">
                    </div>
                    <label class="col-sm-2 control-label" style="padding-right: 0px!important">Ngày học cuối</label>
                    <div class="col-sm-4">
                        <input type="text" id="NgayKetThuc" readonly class="form-control">
                    </div>
                </div>                
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <h5><label class="col-sm-12 control-label text-bold" style="text-align:left">THỰC HIỆN THU TIỀN TÁI PHÍ</label></h5>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Số buổi còn lại</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" readonly id="SoBuoiConLaiTaiPhi" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label" style="padding-left:0px">Số buổi học thêm</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="SoBuoiHocThem" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Đơn giá</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" readonly id="DonGia" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Thành tiền</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" readonly id="ThanhTien" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Hình thức thu</label>
                    <div class="col-sm-9">
                        <div id="HinhThucThu" style="width:100%"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Ngày thu tiền</label>
                    <div class="col-sm-9">
                        <div id="NgayThuTien" style="width:100%"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">Người thu tiền</label>
                    <div class="col-sm-9">
                        <div id="NguoiThuTien" style="width:100%"></div>
                    </div>
                </div>               

            </div>
        </div>
        <!-- /.box-body -->
    </form>
</div>

<div class="box box-danger">
    <div class="box-header with-border">
        <h3 class="box-title">Lịch sử thu học phí - Tái phí</h3>
    </div>
    <!-- /.box-header -->
    <!-- form start -->
    <form class="form-horizontal">
        <div class="row">
            <div class="col-md-12">
                <div id="gridLichSuDangKy"></div>
            </div>
        </div>
        <!-- /.box-body -->
    </form>
</div>

<div class="modal fade" id="TimHocVien" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-red">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">Danh sách học viên đã xếp lớp</h4>
            </div>
            <div class="modal-body">
                <div id="gridDanhSachHocSinhDaXepLop">
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.box -->

<script>
    var ngayketthuchientai, a_hosokhachhang, a_kehoach, a_thdubao, a_sanpham, a_thhopdong=0, thanhtien = 0, tongsobuoi = 0, a_thdubaosp=0;
    var now = new Date();
    $(document).ready(function () {
        $("#NgayThuTien").dxDateBox({
            value: now,
            formatString: 'dd/MM/yyyy',
            onValueChanged: function (data) {
            },
        }).dxDateBox("instance");
        NguoiThuTien();
        HinhThucThu();
        LoadLichSuThuPhi(0, 0);
    })
    function format_Money(nStr) {
        nStr += '';
        x = nStr.split('.');
        x1 = x[0];
        x2 = x.length > 1 ? ',' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }
    function HinhThucThu() {
        $.ajax({
            url: '@Url.Action("Get_CB_HinhThucThu", "ThuPhi")',
            type: 'GET',
            contentType: 'application/json',
            success: function (rs) {
                $("#HinhThucThu").dxSelectBox({
                    items: rs,
                    showPopupTitle: false,
                    displayExpr: "TENLOAIPHIEUTHU",
                    valueExpr: "ID_LOAIPHIEUTHU",
                    searchEnabled: true,
                    onValueChanged: function (e) {
                    },
                });
            }
        })
    }
    function NguoiThuTien() {
        $.ajax({
            url: '@Url.Action("DM_NguoiThuPhi", "ThuPhi")',
            type: 'GET',
            contentType: 'application/json',
            success: function (rs) {
                $("#NguoiThuTien").dxSelectBox({
                    items: rs,
                    showPopupTitle: false,
                    displayExpr: "TENDTTC",
                    valueExpr: "ID_DTTC",
                    searchEnabled: true,
                    onValueChanged: function (e) {
                    },
                });
            }
        })
    }
    function ThuTaiPhi() {
        $.ajax({
            url: '@Url.Action("SaveThuTaiPhi", "TaiPhi")',
            data: {
                A_THDUBAO: a_thdubao, J_HOSOKHACHHANG: a_hosokhachhang, J_TH_HOPDONG: a_thhopdong,
                NgayThuTien: Globalize.format($("#NgayThuTien").dxDateBox('instance').option('value'), 'yyyy-MM-dd'),
                NguoiThuTien: $('#NguoiThuTien').dxSelectBox('instance').option('value'), SoBuoi: tongsobuoi,
                DonGia: $('#DonGia').val().replace(new RegExp(',', 'g'), ''), ThanhTien: $('#ThanhTien').val().replace(new RegExp(',', 'g'), ''),
                NgayKetThuc: $('#NgayKetThuc').val(),
                A_THDUBAO_SP: a_thdubaosp, hinhthucthu: $('#HinhThucThu').dxSelectBox('instance').option('value')
            },
            success: function (data) {
                if (data > 0) {
                    DevExpress.ui.notify('Cập nhật thành công', 'success', 2000);
                    ThemMoiTaiPhi();
                    LoadLichSuThuPhi(a_hosokhachhang, a_thhopdong);
                }
                else {
                    DevExpress.ui.notify('Chưa cập nhật được', 'error', 2000);
                }
            }
        })
    }
    function TimKiemHocSinh() {
        $('#TimHocVien').modal('show');
        LoadDanhSachHocVien();
    }
    function LoadDanhSachHocSinh(hv, lh)
    {
        $('#TimHocVien').modal('hide');
        $.ajax({
            url: '@Url.Action("LoadDanhSachHocSinhDaXepLop", "TaiPhi")',
            type: 'GET',
            data: { HocVien: hv, LopHoc: lh },
            contentType: 'application/json',
            success: function (rs) {
                if (rs.length > 0) {
                    $('#MaHocVien').val(rs[0].MaHocVien);
                    $('#MaLMS').val(rs[0].ma_lms);
                    $('#TIMKIEMHOCVIEN').val(rs[0].TenHocVien);
                    $('#TenLop').val(rs[0].TenLop);
                    $('#TrungTam').val(rs[0].TrungTam);
                    $('#ChuongTrinh').val(rs[0].ChuongTrinh);
                    $('#Buoi1').val(rs[0].Buoi1);
                    $('#Buoi2').val(rs[0].Buoi2);
                    $('#SoBuoiHoc').val(rs[0].SobuoiHoc);
                    $('#NgayBatDau').val(rs[0].NGAYDUKIENHOC);
                    ngayketthuchientai = rs[0].NGAYKETHUCHOC;
                    $('#NgayKetThuc').val(rs[0].NGAYKETHUCHOC);
                    buoi1 = rs[0].ID_PHUONGTHUC;
                    buoi2 = rs[0].ID_CONGCU;
                    a_hosokhachhang = rs[0].A_HOSOKHACHHANG;
                    a_kehoach = rs[0].A_KEHOACH;
                    a_thdubao = rs[0].A_TH_DUBAO;
                    //a_sanpham = rs[0].A_SANPHAM == null ? 0 : rs[0].A_SANPHAM;
                    //a_thdubaosp = rs[0].A_TH_DUBAO_SP;
                    a_thhopdong = rs[0].J_TH_HOPDONG;

                    var now = new Date();
                    var NgayChuyen = Globalize.format(now, 'yyyy-MM-dd');
                    var d = new Date($('#NgayKetThuc').val().split("/").reverse().join("-"));
                    var dd = d.getDate();
                    var mm = d.getMonth() + 1;
                    var yy = d.getFullYear();
                    var newdate = mm + "/" + dd + "/" + yy

                    var bd = new Date($('#NgayBatDau').val().split("/").reverse().join("-"));
                    var ddbd = bd.getDate();
                    var mmbd = bd.getMonth() + 1;
                    var yybd = bd.getFullYear();
                    var newdatebd = mmbd + "/" + ddbd + "/" + yybd;
                    $.ajax({
                        @*url: '@Url.Action("TinhBuoiConLai", "TaiPhi")',
                        data: {
                            ngaybd: rs[0].NGAYDUKIENHOC, ngaykt: rs[0].NGAYKETHUCHOC, KhuVuc: rs[0].ID_KHUVUC, HocVien: a_hosokhachhang, LopHoc: a_kehoach,
                            Buoi1: buoi1, Buoi2: buoi2, sobuoihoc: rs[0].SobuoiHoc, sobuoidahoc: rs[0].SOBUOIDAHOC
                        },*@
                        url: '@Url.Action("TinhBuoiConLai", "TaiPhi")',
                        data: {
                            NgayBatDau: newdatebd, NgayChuyen: NgayChuyen, NgayKetThuc: newdate, KhuVuc: rs[0].ID_KHUVUC, HocVien: a_hosokhachhang,
                            LopHoc: a_kehoach, Buoi1: buoi1, Buoi2: buoi2
                        },
                        type: 'GET',
                        contentType: 'application/json',
                        success: function (rs) {
                            $('#SoBuoiConLai').val(rs);
                            $('#SoBuoiConLaiTaiPhi').val(rs);
                        }
                    })
                    $('#DonGia').val(format_Money(rs[0].DonGia));
                    $('#SoBuoiHocThem').focusout(function () {
                        thanhtien = Number(rs[0].DonGia) * $('#SoBuoiHocThem').val();
                        tongsobuoi = Number($('#SoBuoiConLai').val()) + Number($('#SoBuoiHocThem').val());
                        $('#ThanhTien').val(format_Money(thanhtien));
                        @*$.ajax({
                            url: '@Url.Action("LayNgayKetThuc2", "DangKyBaoLuu")',
                            data: { ngaybd: ngayketthuchientai, SoBuoi: $('#SoBuoiHocThem').val(), Buoi1: buoi1, Buoi2: buoi2 },
                            type: 'GET',
                            contentType: 'application/json',
                            success: function (rs) {
                                $("#NgayKetThuc").val(rs);
                            }
                        })*@
                    })
                    LoadLichSuThuPhi(a_hosokhachhang, a_thhopdong);
                }
            }
        })
    }
    function ThemMoiTaiPhi() {
        $('#TIMKIEMHOCVIEN').val('');
        $('#MaHocVien').val('');
        $('#MaLMS').val('');
        $('#TenHocVien').val('');
        $('#TenLop').val('');
        $('#TrungTam').val('');
        $('#ChuongTrinh').val('');
        $('#Buoi1').val('');
        $('#Buoi2').val('');
        $('#SoBuoiHoc').val('');
        $('#SoBuoiConLai').val('');
        $('#NgayBatDau').val('');
        $("#NgayKetThuc").val('');
        $('#SoBuoiConLaiTaiPhi').val('');
        $('#SoBuoiHocThem').val('');
        $('#DonGia').val('');
        $('#ThanhTien').val('');
        $("#HinhThucThu").dxSelectBox('instance').option('value', null);
        $("#NgayThuTien").dxDateBox('instance').option('value', null);
        $("#NguoiThuTien").dxSelectBox('instance').option('value', null);
    }
    function LoadDanhSachHocVien() {
        $.ajax({
            url: '@Url.Action("GetDanhSachHocSinhDaXepLop", "TaiPhi")',
            type: 'GET',
            data: { HocVien: null },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridDanhSachHocSinhDaXepLop").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 20, 50],
                        showInfo: true
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                        {
                            caption: "Đăng ký", alignment: 'center',
                            width: 100,
                            cellTemplate: function (container, options) {
                                var dt = options.data;
                                //$('<a href="javascript:" onclick="LoadDanhSachHocSinh(\'' + dt.A_HOSOKHACHHANG + '\')"  class="text-green"><b>...</b></a>').appendTo(container);
                                $('<a href="javascript:" onclick="LoadDanhSachHocSinh(' + dt.A_HOSOKHACHHANG + ',' + dt.A_KEHOACH + ')"  class="text-green"><b>...</b></a>').appendTo(container);
                            }
                        },
                          {
                              dataField: "MaDangky",
                              caption: "Mã đăng ký",
                              width: 120,
                          }, {
                              caption: "Mã học viên",
                              dataField: "MaHocVien",
                              width: 120,
                          }, {
                              caption: "Tên học viên",
                              dataField: "TenHocVien",
                              width: 120,
                          }, {
                              dataField: "TenLop",
                              caption: "Tên lớp",
                              width: 200,
                          },
                           {
                               dataField: "TrungTam",
                               caption: "Trung tâm",
                               width: 200,
                           },
                          {
                              dataField: "ChuongTrinh",
                              caption: "Chương trình",
                              width: 120,
                          }, {
                              dataField: "SobuoiHoc",
                              caption: "Số buổi học",
                              width: 200,
                          },
                          {
                              dataField: "DonGia",
                              caption: "Đơn giá",
                              width: 120,
                          },
                          {
                              caption: "Buổi 1",
                              dataField: "Buoi1",
                              width: 120,
                          },
                          {
                              caption: "Buổi 2",
                              dataField: "Buoi2",
                              width: 120,
                          },
                          {
                              caption: "Ngày BĐ học",
                              dataField: "NGAYDUKIENHOC",
                              width: 200,
                          },
                          {
                              caption: "Ngày KT học",
                              dataField: "NGAYKETHUCHOC",
                              width: 120,
                          },
                          {
                              caption: "Trạng thái học",
                              dataField: "TrangThaiHoc",
                              width: 120,
                          },
                    ],

                }).dxDataGrid('instance');
            },
            error: function (a, b, c) {
                DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            }

        });
    }
    function LoadLichSuThuPhi(hv, hd) {
        $.ajax({
            url: '@Url.Action("LichSuThuPhi", "ThuPhi")',
            type: 'GET',
            data: { KhachHang: hv, HopDong: hd, loai: 2 },
            contentType: 'application/json',
            success: function (rs) {
                var dataGrid = $("#gridLichSuDangKy").dxDataGrid({
                    dataSource: rs,
                    allowColumnReordering: false,
                    allowColumnResizing: false,
                    columnAutoWidth: false,
                    columnFixing: {
                        enabled: true
                    },
                    paging: {
                        pageSize: 10
                    },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 20, 50],
                        showInfo: true
                    },
                    selection: {
                        mode: 'multiple'
                    },
                    showColumnLines: true,
                    showRowLines: true,
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    columns: [
                          {
                              dataField: "NGAYTHUTIEN",
                              caption: "Ngày tái phí",
                              width: 200,
                              alignment: "right",
                          }, {
                              dataField: "SOBUOITAIPHI",
                              caption: "Số buổi tái phí",
                              width: 150,
                          },
                           {
                               dataField: "SOTIENTHU",
                               caption: "Số tiền tái phí",
                               width: 200,
                               format: "fixedPoint",
                               alignment: "right",
                           },
                          {
                              dataField: "SoBuoi",
                              caption: "Số buổi còn lại",
                              width: 150,
                          }, {
                              dataField: "SOTIENCONLAI",
                              caption: "Số tiền còn lại",
                              width: 200,
                              format: "fixedPoint",
                              alignment: "right",
                          },
                          {
                              dataField: "NguoiThuTien",
                              caption: "Người thu",
                              width: 300,
                          }
                    ],

                }).dxDataGrid('instance');
            },
            error: function (a, b, c) {
                DevExpress.ui.notify('Error ' + a.status + ': ' + a.statusText, 'error', 2000);
            }

        });
    }
    //function Xoa() {
    //    //$('#myModalPM').modal('show');
    //    swal({
    //                title: "Cảnh báo",
    //                text: "Bạn có chắc muốn xóa không?",
    //                type: "warning",
    //                showCancelButton: true,
    //                cancelButtonText: "Hủy",
    //                confirmButtonColor: '#DD6B55',
    //                confirmButtonText: 'Xóa',
    //                closeOnConfirm: true,
    //            },
    //            function () {

    //            });
    //}
    //function Xoa2() {
    //    DevExpress.ui.notify('Lỗi không xóa được', 'error', 2000);
    //}
</script>
<div id="myModalPM" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
                <h4 class="modal-title">Xác nhận xóa tái phí</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="Xoa2()">Xóa</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
